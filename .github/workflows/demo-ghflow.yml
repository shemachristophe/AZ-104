name: CI PR

on:
  workflow_call:
    secrets: 
      #GITHUB_TOKEN:
        #required: true
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true
  
jobs:
  build:
    name: Validate and Plan
    runs-on: ubuntu-latest
    outputs:
      planMsg: ${{steps.plan_hello.output.planExitMsg }}

    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2.0.0
      
        
      - name: Terraform Init
        run: terraform init
        working-directory: '.github/terraform'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          AWS_ACCESS_KEY_ID:  ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY:  ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        
      - name: Terraform Validate
        run: terraform validate
        working-directory: '.github/terraform'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          AWS_ACCESS_KEY_ID:  ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY:  ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          
      - name: Terraform Plan
        id: plan_hello
        shell: bash
        run: |
          source ../../.github/workflows/run_plan.sh
          get_terraform_plan_return_message 
          
        working-directory: '.github/terraform'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          AWS_ACCESS_KEY_ID:  ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY:  ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          TF_CLI_ARGS: '-var-file="../../.github/terraform/env/dev.tfvars"'
          
      - name: Check for Plan Failure
        shell: bash
        if: steps.plan_hello.outputs.planExitMsg == 'State Change Detected!'
        run: echo "correctly returned message"            
          
          
  apply:    
    name: Apply terraform plan
    needs: [build]
    if: needs.build.outputs.planMsg == 'State Change Detected!'
    runs-on: ubuntu-latest

    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Terraform
        uses: ./.github/actions/deploy_ci
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          AWS_ACCESS_KEY_ID:  ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY:  ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          
